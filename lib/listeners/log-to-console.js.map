{"version":3,"sources":["../../src/listeners/log-to-console.js"],"names":[],"mappings":"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","file":"log-to-console.js","sourcesContent":["import _ from 'lodash-firecloud';\nimport fastSafeStringify from 'fast-safe-stringify';\nimport moment from 'moment';\n\nlet _isBrowser = typeof window !== 'undefined';\nlet _isNode = typeof process !== 'undefined' && !_.isUndefined(_.get(process, 'versions.node'));\nlet _isAwsLambda = _isNode && !_.isUndefined(process.env.LAMBDA_TASK_ROOT);\n\n// from https://github.com/Financial-Times/lambda-logger\n// This does make process.stdout.write a blocking function (process.stdout._handle.setBlocking(true);),\n// as AWS Lambda previously streamed to an output which was synchronous,\n// but has since changed to asynchronous behaviour, leading to lost logs.\nif (_isAwsLambda && _.isFunction(_.get(process, 'stdout._handle.setBlocking'))) {\n  process.stdout._handle.setBlocking(true);\n}\n\nlet _levelToConsoleFun = function({level, levels}) {\n  // on AWS Lambda the console.trace call will print '[object Object]'¯\\_(ツ)_/¯\n  // plus all console funs end up in a cloudwatch stream\n  if (_isAwsLambda) {\n    return 'log';\n  }\n\n  if (_.isString(level)) {\n    // eslint-disable-next-line prefer-destructuring\n    level = levels[level];\n  }\n\n  if (_.inRange(level, 0, levels.warn)) {\n    return 'error';\n  } else if (_.inRange(level, levels.warn, levels.info)) {\n    return 'warn';\n  } else if (_.inRange(level, levels.info, levels.debug)) {\n    return 'info';\n  } else if (_.inRange(level, levels.debug, levels.trace)) {\n    // return 'debug';\n    // console.debug doesn't seem to print anything,\n    // but console.debug is an alias to console.log anyway\n    return 'log';\n  } else if (level === levels.trace) {\n    return 'trace';\n  }\n\n  return 'log';\n};\n\n/*\ncfg has 2 properties\n- contextId (optional, default to 'top' in browser and undefined elsewhere)\n  An identifier for the current \"context\".\n- level (optional, defaults to trace)\n  Any log entry less important that cfg.level is ignored.\n*/\n\nexport let logToConsole = function(cfg = {}) {\n  let contextId;\n  let hasCssSupport = false;\n\n  if (_isBrowser) {\n    if (window.parent === window) {\n      contextId = 'top';\n    }\n    hasCssSupport = true;\n  }\n\n  _.defaults(cfg, {\n    contextId,\n    level: 'trace'\n  });\n\n  let maybeCss = function(css) {\n    return hasCssSupport ? css : '';\n  };\n\n  return async function({entry, logger, rawEntry}) {\n    if (_.filter(rawEntry._args).length === 1 && rawEntry._args[0]._babelSrc) {\n      return;\n    }\n\n    if (logger.levelIsBeyondGroup(entry._level, cfg.level)) {\n      return;\n    }\n\n    let now = moment(entry._time.stamp).utcOffset(entry._time.utc_offset).toISOString();\n    let levelName = logger.levelToLevelName(entry._level);\n    let formattedLevelName = _.padStart(_.toUpper(levelName), '5');\n    let consoleFun = _levelToConsoleFun({\n      level: entry._level,\n      levels: logger.levels\n    });\n\n    let color = '';\n    switch (consoleFun) {\n    case 'log':\n    case 'info':\n    case 'trace':\n      color = maybeCss('color: dodgerblue');\n      break;\n    default:\n    }\n\n    let maybeContextFormat = _.isUndefined(cfg.contextId) ? '' : ' %s';\n\n    let src = '';\n    if (entry._babelSrc) {\n      src = _.merge({}, entry._src, entry._babelSrc);\n      src = ` @webpack:///./${src.file}:${src.line}:${src.column}${src.function ? ` in ${src.function}()` : ''}`;\n    } else if (entry._src) {\n      src = entry._src;\n      src = ` ${src.file}:${src.line}:${src.column}${src.function ? ` in ${src.function}()` : ''}`;\n    }\n\n    let prefixFormat = `%c%s${maybeContextFormat} %c%s%c%s`;\n    if (!hasCssSupport) {\n      prefixFormat = _.replace(prefixFormat, /%c/g, hasCssSupport ? '%c' : '%s');\n    }\n    let prefixArgs = [\n      maybeCss(color),\n      now,\n      _.isUndefined(cfg.contextId) ? '' : cfg.contextId,\n      maybeCss('font-weight: bold'),\n      formattedLevelName,\n      maybeCss(color),\n      src\n    ];\n\n    let msgFormat = '';\n    let msgArgs = [];\n    if (entry.msg) {\n      let {\n        _duration: duration,\n        msg\n      } = entry;\n      if (duration) {\n        msg = `${msg} - took ${duration.ms} ms`;\n        if (duration.ms > 1000) {\n          msg = `${msg} (${duration.human})`;\n        }\n      }\n\n      msgFormat = '\\n%s';\n      msgArgs = [\n        msg\n      ];\n    }\n\n    let extraFormat = '';\n    let extraArgs = [];\n\n    let extra = _.omit(rawEntry, [\n      '_args',\n      '_babelSrc',\n      '_duration',\n      '_level',\n      '_src',\n      '_time',\n      '_timeEnd',\n      '_timeStart',\n      'contextId',\n      'msg'\n    ]);\n    extra = _.omitBy(extra, function(_value, key) {\n      return /^_arg[0-9+]$/.test(key);\n    });\n\n    let context = {};\n    if (_isBrowser) {\n      _.merge(context, {\n        window,\n        documentElement: window.document.documentElement\n      });\n    }\n    _.merge(extra, context);\n\n    // devTools console sorts keys when object is expanded\n    extra = _.toPairs(extra);\n    extra = _.sortBy(extra, 0);\n    extra = _.fromPairs(extra);\n\n    // devTools collapses objects with 'too many' keys,\n    // so we output objects with only one key\n    _.forEach(extra, function(value, key) {\n      extraArgs.push('\\n');\n      let obj = {\n        [key]: value\n      };\n\n      // fix for util.inspect having no indentation\n      if (!_isBrowser) {\n        obj = fastSafeStringify(obj, undefined, 2);\n      }\n\n      extraArgs.push(obj);\n    });\n\n    let format = `${prefixFormat}:${msgFormat}${extraFormat}`;\n    let vars = [\n      ...prefixArgs,\n      ...msgArgs,\n      ...extraArgs\n    ];\n\n    if (_isAwsLambda) {\n      // eslint-disable-next-line global-require\n      process.stdout.write(require('util').format(format, ...vars));\n      return;\n    }\n\n    // eslint-disable-next-line no-console\n    console[consoleFun](format, ...vars);\n  };\n};\n\nexport default logToConsole;\n"]}